TS
===



TS 全称是 MPEG2-TS，MPEG2-TS 是一种标准容器格式，传输与存储音视频、节目与系统信息协议数据，广泛应用于数字广播系统，我们日常数字机顶盒接收到的就是 TS（Transport Stream，传输流）流。

首先需要先分辨 TS 传输流中几个基本概念

    ES（Elementary Stream）：基本流，直接从编码器出来的数据流，可以是编码过的音频、视频或其他连续码流
    PES（Packetized Elementary Streams）：PES 流是 ES 流经过 PES 打包器处理后形成的数据流，在这个过程中完成了将 ES 流分组、加入包头信息 （PTS、DTS 等）操作。PES 流的基本单位是 PES 包，PES 包由包头和 payload 组成
    PS 流（Program Stream）：节目流，PS 流由 PS 包组成，而一个 PS 包又由若干个 PES 包组成。一个 PS 包由具有同一时间基准的一个或多个 PES 包复合合成。
    TS 流（Transport Stream）：传输流，TS 流由固定长度（188 字节）的 TS 包组成，TS 包是对 PES 包的另一种封装方式，同样由具有同一时间基准的一个或多个 PES 包复合合成。PS 包是不固定长度，而 TS 包为固定长度。
    
    为便于传输，实现时分复用，基本流 ES 必须打包，就是将顺序连续、连续传输的数据流按一定的时间长度进行分割，分割的小段叫做包，因此打包也被称为分组。

MPEG-2 标准中，有两种不同的码流可以输出到信号，一种是节目码流（PS Program Stream），一种是传输流（TS Transport Stream）。

PS 流包结构长度可变，一旦某一 PS 包的同步信息丢失，接收机就无法确认下一包的同步位置，导致信息丢失，因此 PS 流适用于合理可靠的媒体，如光盘（DVD），PS 流的后缀名一般为 vob 或 evo。而 TS 传输流不同，TS 流的包结构为固定长度（一般为 188 字节），当传输误码破坏了某一 TS 包的同步信息时，接收机可在固定的位置检测它后面包中的同步信息，从而恢复同步，避免信息丢失，因此 TS 可适用于不太可靠的传输，即地面或卫星传播，TS 流的后缀一般为 ts、mpg、mpeg。

    由于 TS 码流具有较强的抵抗传输误码的能力，因此目前在传输媒体中进行传输的 MPEG-2 码流基本上都采用了 TS

2 基本流程
2.1 TS 流形成过程

image

以电视数字信号为例：
1) 原始音视频数据经过压缩编码得到基本流 ES 流

生成的 ES 基本流比较大，并且只是 I、P、B 这些视频帧或音频取样信息。
2) 对 ES 基本流 进行打包生成 PES 流

通过 PES 打包器，首先对 ES 基本流进行分组打包，在每一个包前加上包头就构成了 PES 流的基本单位 —— PES 包，对视频 PES 来说，一般是一帧一个包，音频 PES 一般一个包不超过 64KB。

PES 包头信息中加入了 PTS、DTS 信息，用与音视频的同步。
3) 同一时间基准的 PES 包经过 TS 复用器生成 TS 传输包

PES 包的长度通常都是远大于 TS 包的长度，一个 PES 包必须由整数个 TS 包来传送，没装满的 TS 包由填充字节填充。PES 包进行 TS 复用时，往往一个 PES 包会分存到多个 TS 包中

将 PES 包内容分配到一系列固定长度的传输包（TS Packet）中。TS 流中 TS 传输包头加入了 PCR（节目参考时钟）与 PSI（节目专用信息），其中 PCR 用于解码器的系统时钟恢复。

image

    PCR 时钟作用：我们知道，编码器中有一个系统时钟，用于产生指示音视频正确显示和解码的时间标签（DTS、PTS）。解码器在解码时首先利用 PCR 时钟重建与编码器同步的系统时钟，再利用 PES 流中的 DTS、PTS 进行音视频的同步。

4) 连续输出传输包形成具有恒定比特率的 MPEG-TS 流
2.2 TS 流解析过程
1) 从复用的 MPEG-TS 流中解析出 TS 包
2) 从 TS 包中获取 PAT 及节目对应的 PMT，解析获取音视频

首先简单了解一下什么是 PSI，后面会通过例子更详细的介绍。

PSI 是节目特定信息，该表格信息用来描述传送流的组成结构。PSI 信息由四种类型的表组成，包括节目关联表（PAT，Program Association Table）、节目映射表（PMT，Program Map Table）、条件接收表（CAT）、网络信息表（NIT）。PAT 与 PMT 两张表帮助我们找到该传送流中的所有节目与流，PAT 告诉我们，TS 流是由哪些节目组成，每个节目的节目映射表 PMT 的 PID 是什么，而 PMT 告诉我们，该节目由哪些流组成，每一路流的类型与 PID 是什么。CAT 与 NIT 暂时不考虑。

image

从图中 PAT 表中可以获取该 TS 流中包含哪些节目，并通过 PAT 表中具体节目的 PMT 表 PID 值（如节目 0 对应 17 PMT PID），找到该节目对应的 PMT 表，而有了 PMT 表我们就知道该节目有哪些流以及流的类型（视频、音频等），进而获取到音视频流对应的 PID。
3) 通过 PID 筛选出特定音视频流的 TS 包，并解析出 PES
4) 从 PES 中读取到 PTS/DTS，并从 PES 中解析出基本码流 ES
5) 将 ES 交给解码器解码
3 TS 格式
3.1 TS 包格式

TS 包主要由两部分组成，一个是 4 字节的包头信息，二是有效负载，另外由于每个包固定需要 188 字节，所以中间有可能需要插入自适应调整字段。其中有效负载包括 PSI（节目专用信息）、PES（打包后的基本流）及其他业务信息。



































---

- 邮箱 ：charon.chui@gmail.com  
- Good Luck! 